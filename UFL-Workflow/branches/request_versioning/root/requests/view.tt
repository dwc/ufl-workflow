[% USE Textile %]
[% SET
   title = request.title
   status_id = 'status_id'
   group_id = 'group_id'
   field_error = 'field_error'
   edit_field_form = 'edit_field_form'
   scripts = [
     c.uri_for('/static/javascript/jquery.js'),
     c.uri_for('/static/javascript/jquery.jeditable.js'),
     c.uri_for('/static/javascript/UFL/Workflow/Form/StatusGroupAssignment.js'),
     c.uri_for('/static/javascript/UFL/Workflow/Form/EditField.js'),
   ]
   snippets = [
     "new UFL.Workflow.Form.StatusGroupAssignment('${c.uri_for(c.controller('Requests').action_for('list_action_groups'), request.uri_args)}', '$status_id', '$group_id');",
     "new UFL.Workflow.Form.EditField('${c.uri_for(c.controller('Requests').action_for('edit_field'),request.uri_args)}', '$field_error', '$edit_field_form');",
   ]
-%]
[% IF request.can_be_edited(version, c.user) %]
<h3>Edit Request</h3>
<ul>
  <li><a href="[% c.uri_for(c.controller.action_for('edit'), request.uri_args) | html %]">Edit this request</a></li>
</ul>
<span class="edit_status"><a id="[% field_error %]"></a></span>
[% END %]
[% SET version_count = request.all_version_count %]

[% IF version_count > 1 %]
<div class="left">
[% END %]
[% IF request.can_be_edited(version, c.user) %]
<form id="[% edit_field_form %]" action="[% c.uri_for(c.controller.action_for('edit'), request.uri_args) | html %]" method="post">
[%END%]
<h3>Request details [% IF request.current_version.version != version.version %] of version [% version.version %] [% END %]</h3>
<dl>
  [% field_data = version.first_field_data  %]
  [% IF field_data %]
  [% INCLUDE requests/includes/field_data.tt %]
  [% END %]
  <dt>Process</dt>
  <dd>[% request.process.name | html %]</dd>
  <dt>Status</dt>
  <dd>[% INCLUDE requests/includes/status.tt action = request.current_action %] (<a href="#actions">Details</a>)</dd>
  <dt>Submitter</dt>
  <dd>[% request.submitter.username | html %]</dd>
  <dt>Created</dt>
  <dd>[% version.insert_time.strftime(datetime_format) | html %]</dd>
  <dt>Updated</dt>
  <dd>[% version.update_time.strftime(datetime_format) | html %]</dd>
</dl>
<br style="clear:both" />
[% IF request.can_be_edited(version, c.user) %]
</form>
[%END%]


[% IF version_count > 1 %]
</div><!-- .left  -->
<div class="right">
<form action="[% c.uri_for(c.controller.action_for('version_diff'), request.uri_args) | html %]" method="post">
<a class="center" [% IF version_count > 8 %]href='[% c.uri_for(c.controller.action_for('versions'), request.uri_args) | html %]' [% END %]>Versions</a>
  <input class="submit" type="submit" value="Compare" />
<ul class="versioning">
[% FOREACH rev_version IN [1 .. version_count] %]
    [% IF rev_version <= 8 %]
    [% SET ver = version_count - rev_version + 1 %]
    [% IF ver == version.version %]
      <li class="current"><label class="checkbox"><input type="checkbox" name="[% ver | html %]" value="1" class="diff"/></label>[% request.version(ver).insert_time.strftime("%e-%b-%y") | html %]&nbsp;[% request.version(ver).submitter.username | html %]</li>
    [% ELSE %]
      <li><label class="checkbox"><input type="checkbox" name="[% ver | html %]" value="1" class="diff"/></label><a href="[% c.uri_for(c.controller.action_for('view'), request.uri_args) | html %]/version/[% ver | html %]">[% request.version(ver).insert_time.strftime("%e-%b-%y") | html %]</a>&nbsp;[% request.version(ver).submitter.username | html %]</li>
    [% END %]
    [% END %]
  [% END %]
  </ul><!-- .paging -->
</div>
[% END %]
[% IF request.can_be_edited(version, c.user) %]
</form>
[% END %]

<h3>Documents</h3>
[% SET docs_so_far = 0%]
[% SET i = 0 %]
[% FOREACH rev_version IN [1 .. version_count] %]
[% SET ver = version_count - rev_version + 1 %]
[% SET documents = request.version(ver).documents_rs %]
[% IF documents.count > 0 %]
[% IF docs_so_far == 0 %]
<table>
  <tr>
    <th>Added in version</th>
    <th>Title</th>
    <th>Replacement</th>
    <th>Created</th>
  </tr>
[% docs_so_far = 1; %]
[% END %]
  [% WHILE (document = documents.next) %]
    <tr[% IF i % 2 == 0 %] class="even"[% END %]>
    [% SET replacement = document.replacement %]
    <td ><a href="[% c.uri_for(c.controller.action_for('view'), request.uri_args) | html %]/version/[% ver | html %]">[% request.version(ver).insert_time.strftime("%e-%b-%y") | html %]</a></td>
    <td[% IF replacement %] class="replaced"[% END %]><a href="[% c.uri_for(c.controller('Documents').action_for('download'), document.uri_args) | html %]">[% document.name | html %]</a></td>
    <td[% IF replacement %] class="replaced"[% END %]>[% IF replacement %]<a href="[% c.uri_for(c.controller('Documents').action_for('download'), replacement.uri_args) | html %]">[% replacement.name | html %]</a>[% END %]</td>
    <td[% IF replacement %] class="replaced"[% END %]>[% document.insert_time.strftime(datetime_format) | html %]</td>
    </tr>
    [% SET i = i + 1 %]
  [% END %]
[% END %]
[% END %]
[% IF docs_so_far == 1 %]
</table>
[% ELSE %]
<p>None yet.</p>
[% END %]
[% IF request.can_be_edited(version, c.user) %]
<p><a href="[% c.uri_for(c.controller.action_for('add_document'), request.uri_args) | html %]">Add a document</a></p>
[% END -%]

<h3 id="actions">Actions</h3>
[% SET action = request.first_action %]
[% SET current_action = request.current_action %]
[% IF action %]
<table>
  <tr>
    <th>Step</th>
    <th>Status</th>
    <th>Group</th>
    <th>User</th>
    <th>Comment</th>
    <th>Updated</th>
  </tr>
  [% SET i = 0 %]
  [% WHILE action %]
  <tr[% IF i % 2 == 0 %] class="even"[% END %]>
    <td>[% action.step.name | html %]</td>
    <td>[% action.status.name | html %]</td>
    <td>[% action.group.name | html %]</td>
    <td>[% action.actor.username || '-' | html %]</td>
    <td>[% action.comment || '-' | html %]</td>
    <td>[% action.update_time.strftime(datetime_format) | html %]</td>
  </tr>
    [% SET action = action.next_action %]
    [% SET i = i + 1 %]
  [% END %]
  [% SET step = request.next_step %]
  [% WHILE step %]
  <tr[% IF i % 2 == 0 %] class="even"[% END %]>
    <td>[% step.name | html %]</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
  </tr>
    [% SET step = step.next_step %]
    [% SET i = i + 1 %]
  [% END %]
</table>

  [% IF c.user.can_decide_on(current_action) %]
<h3>Decision</h3>
<p>You can make a decision on the <strong>[% current_action.step.name | html %]</strong> step of this request.</p>
<form action="[% c.uri_for(c.controller.action_for('update_status'), request.uri_args) | html %]" method="post">
    [% FILTER indent('  ') %]
      [% INCLUDE statuses/includes/statuses.tt statuses = current_action.statuses, field_id = status_id, field_label = 'Set status to' %]
    [% END %]
  <label>Send to group:
    <select name="group_id" id="[% group_id | html %]">
    </select>
  </label>
  <label>Comment: <textarea name="comment"></textarea></label>
  <input type="submit" class="submit" value="Submit Decision" />
</form>
  [% END %]
[% ELSE %]
<p>None yet.</p>
[% END %]
